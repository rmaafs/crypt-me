<!doctype html>
<html>

<head>
  <meta name="generator" content="JSDoc 3.6.7">
  <meta charset="utf-8">
  <title>crypt-me 1.1.0 &raquo; Source: Server.js</title>
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Karla:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Noto+Serif:400,400i,700,700i" type="text/css">
  <link rel="stylesheet" href="https://brick.a.ssl.fastly.net/Inconsolata:500" type="text/css">
  <link href="css/baseline.css" rel="stylesheet">
</head>

<body onload="prettyPrint()">
  <nav id="jsdoc-navbar" role="navigation" class="jsdoc-navbar">
    <div id="jsdoc-navbar-container">
      <div id="jsdoc-navbar-content">
        <a href="index.html" class="jsdoc-navbar-package-name">crypt-me 1.<wbr>1.<wbr>0</a>
      </div>
    </div>
  </nav>
  <div id="jsdoc-body-container">
    <div id="jsdoc-content">
      <div id="jsdoc-content-container">
        <div id="jsdoc-banner" role="banner">
        </div>
        <div id="jsdoc-main" role="main">
          <header class="page-header">
            <h1>Source: Server.js</h1>
          </header>
          <article>
            <pre class="prettyprint linenums"><code>import Database from &quot;./Database&quot;;

const express &#x3D; require(&quot;express&quot;);
const cors &#x3D; require(&quot;cors&quot;);

/**
 * Función que inicia el API REST
 * @returns Retorna la instancia del servidor express
 */
function Server() {
  let app &#x3D; express().use(cors()).use(express.json()); //Crea al servidor
  const port &#x3D; process.env.PORT || 20203; //Puerto donde abriremos el servicio

  app.use((req, res, next) &#x3D;&gt; {
    if (!req) return; //Para que no me aparezca que no usé la variable jaja

    res.header(&quot;Access-Control-Allow-Origin&quot;, &quot;*&quot;);
    next();
  });

  const db &#x3D; new Database(() &#x3D;&gt; {
    /**
     * Función que ejecutará el servidor API REST
     */
    //Eliminamos los registros viejos en la base de datos
    setInterval(function () {
      db.deleteDueRegs();
    }, 15 * 60 * 1000); //Cada 15 minutos

    //Abrimos el servicio de API REST
    const server &#x3D; app.listen(port, () &#x3D;&gt; {
      console.log(&#x60;API REST Ejecutado en el puerto http://localhost:${port}&#x60;);
      app.emit(&quot;appStarted&quot;, server, db);
    });
  });

  //Ruta GET / para saber si el servicio está corriendo
  app.get(&quot;/&quot;, (req, res) &#x3D;&gt; {
    res.status(200).json({ message: &quot;Works!&quot; });
  });

  //Ruta POST / para mandar los mensajes
  app.post(&quot;/&quot;, async (req, res) &#x3D;&gt; {
    //Guardamos la IP del que lo envía
    const ip &#x3D; req.headers[&quot;x-forwarded-for&quot;] || req.socket.remoteAddress;
    //Texto a encriptar
    const text &#x3D; req.body.text || &quot;&quot;;

    await db
      .addReg(text, ip)
      .then((data) &#x3D;&gt; {
        if (data.id) {
          res.status(201).json(data);
        } else {
          res
            .status(400)
            .json({ error: &quot;Hubo un error al procesar tu solicitud.&quot; });
        }
      })
      .catch((err) &#x3D;&gt; {
        res.status(400).json({ error: err });
      });
  });

  //Ruta PATCH / para obtener el texto desencriptado
  app.patch(&quot;/&quot;, async (req, res) &#x3D;&gt; {
    //Guardamos la IP del que lo envía
    //const ip &#x3D; req.headers[&quot;x-forwarded-for&quot;] || req.socket.remoteAddress;
    //ID del texto
    const id &#x3D; req.body.id || &quot;&quot;;
    //Secret para desencriptar
    const secret &#x3D; req.body.secret || &quot;&quot;;

    await db
      .getReg(id, secret)
      .then((data) &#x3D;&gt; {
        if (data.text) {
          res.status(200).json(data);
        } else {
          res
            .status(400)
            .json({ error: &quot;Hubo un error al procesar tu solicitud.&quot; });
        }
      })
      .catch((err) &#x3D;&gt; {
        res.status(400).json({ error: err });
      });
  });

  return app;
}

export default Server;
</code></pre>
          </article>
        </div>
      </div>
      <nav id="jsdoc-toc-nav" role="navigation"></nav>
    </div>
  </div>
  <footer id="jsdoc-footer" class="jsdoc-footer">
    <div id="jsdoc-footer-container">
      <p>
        Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc</a> 3.6.7 on September 13, 2021.
      </p>
    </div>
  </footer>
  <script src="scripts/jquery.min.js"></script>
  <script src="scripts/tree.jquery.js"></script>
  <script src="scripts/prettify.js"></script>
  <script src="scripts/jsdoc-toc.js"></script>
  <script src="scripts/linenumber.js"></script>
  <script src="scripts/scrollanchor.js"></script>
</body>

</html>